# 阶段 4 启动方案（工具链与扩展能力）

本方案用于指导 ZCAD Rust 迁移计划的阶段 4 执行（参考 `rust/PORTING_PLAN.md:42-46`），聚焦于运行时生成工具链、配置/国际化/插件体系以及脚本桥接验证。目标是在 4 周内交付可复现的构建与扩展基础设施，为后续电气模块与性能验证阶段铺路。

## 1. 运行时工具链替换

| 任务 | 说明 | 产出 | 依赖 |
| --- | --- | --- | --- |
| runtime_builder CLI/脚本 | 以 Rust 实现 `typeexporter` + Makefile 流程：清理/创建 `cad/` `cad_source/autogenerated/`，复制 `environment/runtimefiles`，生成 `buildmode.inc`、`zcadversion.inc`、`allgeneratedfiles.inc`（详见 `BUILD_FROM_SOURCES.md:65-71`）。 | `cargo run -p runtime-builder -- --clean --target runtime/dist --product <zcad|zcadelectrotech> [--platform <triple>]`，自动生成 `runtime_manifest.json`，并可通过 `runtime-builder verify --manifest runtime/dist/runtime_manifest.json` 进行校验；`cargo run -p runtime-builder -- typeexport`（或 `make -C rust typeexport`）已完成 Phase A 的 `allgeneratedfiles.inc`/`buildmode.inc` 生成；CI 作业。 | 环境路径探测、版本号来源。 |
| 资源 manifest 与校验 | 扫描 Raster/字体/电气资源，输出 manifest（JSON/TOML）及 hash，构建完成后校验缺失文件。 | `runtime/manifest.json`、校验脚本、CI 检查。 | runtime_builder 复制流程。 |
| 配置联动 | 扩展 `zcad-config`：运行时路径、资源镜像（`resources.runtime_root`、`image_roots`）与 `auto_copy_runtime` 校验，提供错误提示。 | 更新的 `zcad-config` crate + `config/default.toml`。 | CLI/Bevy 启动流程、`rust/zcad-app/src/runtime_assets.rs`。 |
| CI 接入 | 新增 GitHub Actions/CI 任务：运行 runtime_builder、校验 manifest，并存档日志供调试。 | `.github/workflows/zcad-runtime.yml`（示例）。 | 现有 Rust CI 管线。 |

风险与对策：
- **跨平台路径差异**：采用 `camino`/`std::path` 统一处理，必要时对 Windows/macOS/Linux 做单测。
- **typeexporter 逻辑迁移难度**：优先梳理 `environment/typeexporter` 参数，必要时复用其输出（临时 shell out）作为过渡，逐步重写。

> 备注：运行 `runtime-builder` 的输出目录 `rust/runtime/dist/` 已加入 `.gitignore`，避免误提交。

命令行入口：`make -C rust runtime` 将自动调用 `cargo run -p runtime-builder`，并可通过 `RUNTIME_PRODUCT`/`RUNTIME_PLATFORM`/`RUNTIME_TARGET` 等变量覆盖默认行为；CI 也会在 `make -C rust ci` 时默认执行该步骤。`make -C rust app` 则在准备运行时后直接运行 `zcad-app`，便于本地验证。若需校验现有输出，可执行 `cargo run -p runtime-builder -- verify --manifest runtime/dist/runtime_manifest.json [--target runtime/dist]`。`make -C rust typeexport` 封装了 Phase A 的 inc 生成流程，支持 `TYPEEXPORT_PROCESS_FILES`、`TYPEEXPORT_DEFINES` 覆盖默认参数。

## 2. 配置、国际化与插件接口

| 任务 | 说明 | 产出 |
| --- | --- | --- |
| 配置 Schema 扩展 | 在 `zcad-config` 定义脚本路径、插件搜索目录、语言首选项、电气模块开关等字段，支持环境变量覆盖与 schema 校验。 | `zcad-config` 更新、示例 `default.toml`、文档。 |
| i18n 资源管线 | 选择格式（建议 FTL 或 JSON），编写打包/热加载工具；在 CLI/Bevy 层实现语言切换 API。 | `i18n/` 目录、打包脚本、示例翻译。 |
| 插件 API 草案 | 设计命令注册、文档访问、生命周期回调、安全策略：可先定义 trait + `PluginContext`，并写出电气模块所需接口映射。 | `docs/plugins_api.md`、`zcad-core`/`zcad-app` 草案代码。 |

风险与对策：
- **配置项膨胀**：引入 schema 校验与文档生成（如 `schemars`），避免选项失控。
- **i18n 资源体积**：在 manifest 中记录语言包文件，构建时按需注入。

## 3. 脚本/插件桥接 PoC（Lua/Python/WASM）

| 步骤 | 内容 | 验收 |
| --- | --- | --- |
| 技术选型 | 评估 `mlua`、`pyo3`、`wasmtime` 各自的嵌入复杂度、安全模型与部署差异，确定首个 PoC（建议 Lua）。 | 选型报告 + 决策。 |
| API 设计 | 暴露最小 API：加载 DXF、遍历实体、发出命令。提供 `ScriptContext`，实现沙箱（文件访问、CPU 限制）。 | `script_bridge` crate 或模块 + Rust 文档。 |
| CLI 集成 | 在 `zcad-app` 增加 `--script path.lua` 等入口，支持日志输出与错误传播。 | CLI 运行演示 + smoke test。 |
| 示例与测试 | 提供示例脚本（如批量查询实体）及集成测试验证桥接可用。 | `examples/scripts/*.lua`、CI 任务。 |

风险与对策：
- **安全性**：默认沙箱禁止任意 IO，仅暴露受控 API，可通过配置开启扩展能力。
- **依赖体积**：Lua 解释器可选 `mlua` + `lua-src`（纯 Rust 编译），避免外部依赖。

## 4. 里程碑与资源

| 时间点 | 目标 | 需要的协作 |
| --- | --- | --- |
| 第 1 周 | 完成 runtime_builder 原型，能复制运行时并生成基本文件；提交 CI 任务。 | Pascal 团队提供 `typeexporter` 生成物样例。 |
| 第 2 周 | 扩展配置 schema、发布 i18n 管线草案，完成 manifest 校验。 | 文档团队确认语言包格式。 |
| 第 3 周 | 脚本桥接 PoC（Lua）可运行，CLI demo + smoke test。 | 前端/命令系统提供 API 接口。 |
| 第 4 周 | 插件 API 草案 + 电气模块需求映射，runtime_builder/脚本桥接文档完备。 | 电气团队评审接口。 |

## 5. 未决问题

1. `typeexporter` 生成逻辑中是否存在 Pascal 侧专属宏需保留？若仍需 Pascal 可执行，是否通过 FFI 调用或完全 Rust 重写？
2. 运行时资源是否需要按平台拆分（AllCPU vs 特定架构）？需要 manifest 标注平台限制。
3. 电气扩展对脚本接口的 API 需求是否包含 GUI/交互？需在阶段 4 早期确认以免返工。

---

更新节奏：阶段 4 期间每周复盘一次，必要时在 `docs/` 增量记录推进结果与风险。

## 6. 下一阶段开发路线（typeexporter 替换）

（详见 `docs/typeexporter_replacement.md`）

1. **Phase A**：在 `runtime-builder` 中实现 `.files` 解析与 `{REGISTER...}` 扫描，生成 `allgeneratedfiles.inc` 与 `buildmode.inc`。保留顺序并提供 `--define`/`--process-files` 参数。
2. **Phase B**：补齐 `areg*.pas` 模块模板，确保生成内容与 Pascal 版一致，并引入快照测试。
3. **Phase C**：实现 `zcadversion.inc`/`zcadversion.txt` 与 `system.pas` 输出，提供 `runtime-builder typeexport --version-string` 等覆盖参数。
4. **Phase D**：向 CI 输出 JSON manifest，供 Pascal/Rust 双侧共享，完成与 `make`/`cargo` 的统一。
